<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marauder's Map</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <script src="js/vendor/modernizr.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
        <script src="js/vendor/jquery.js"></script>
        <script src="js/foundation.min.js"></script>
    <style>
      .full-height {display: table;}
      .full-width {
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        max-width: initial;
      }
    </style>
    <script>
          $(document).foundation();
      var ws;
      var map;
      var players = {};

      function initializeMap() {
        var mapOptions = {
          zoom: 8,
          center: new google.maps.LatLng(-34.397, 150.644)
        };
        map = new google.maps.Map(
          document.getElementById('map_canvas'),
          mapOptions
        );
      }

      function updatePlayer(player_id, location) {
        if (players.hasOwnProperty(player_id)) {
          players[player_id].setPosition(location);
        } else {
          var marker = new google.maps.Marker({
            position: location,
            map: map,
            title: player_id
          });
          players[player_id] = marker;
        }
      }

      function clearPlayers() {
        for (var key in players) {
          if (players.hasOwnProperty(key)) {
            players[key].setMap(null);
          }
        }
        players = {};
      }

      var game_id;
      var player_id;

      function populateGames(callback) {
        $.getJSON("api/list_games", function(data) {
          var games = data["games"];
          var game_selector = $("#game_selector");
          game_selector.empty();
          $.each(games, function() {
            game_selector.append($("<option />").text(this));
          });
          game_selector.change(function () {
            changeGame(game_selector.val());
          });
          callback(game_selector);
        });
      }

      function changeGame(new_game_id) {
        game_id = new_game_id;
        if (ws != null) {
          ws.close();
        }
        ws = new WebSocket("ws://localhost:8080/api/games/" + game_id + "/websocket");
        ws.onmessage = function (evt) {
          handleMessage(evt.data);
        }
        google.maps.event.addListener(map, 'click', function(event) {
          sendMessage(event.latLng, ws);
        });
        clearPlayers();
        initialMarkers();
      }

      function initialMarkers() {
        $.getJSON("api/games/" + game_id + "/list_players",
          function(data) {
            $.each(data["players"], function () {
              var player_id = this["player_id"];
              var lat = this["lat"];
              var lng = this["lng"];
              var loc = new google.maps.LatLng(lat, lng);
              updatePlayer(player_id, loc);
            });
          });
      }

      function sendMessage(loc, socket) {
        msg = {
          "game_id" : game_id,
          "player_id" : $("#name_selector").val(),
          "lat" : loc.lat(),
          "lng" : loc.lng()
        };
        socket.send(JSON.stringify(msg));
      }

      function handleMessage(input) {
        data = JSON.parse(input)
        loc = new google.maps.LatLng(data["lat"], data["lng"]);
        updatePlayer(data["player_id"], loc);
      }

      google.maps.event.addDomListener(window, 'load', initializeMap);
      populateGames(function (options) {
        if (options.length > 0) {
          changeGame(options.val());
        }
      });
    </script>
  </head>
  <body>
    <div class="row full-height full-width">
      <div class="large-10 column full-height" id="map_canvas"></div>
      <div class="large-2 column full-height">
        <label for="game_selector">Select a game</label>
        <select id="game_selector" class="medium">
        </select>
        <label for="name_selector">Select a name</label>
        <input type="text" id="name_selector" placeholder="Type your name here">
        Click on the map to update your location!
      </div>
    </div>
    <script>
      $(".full-height").height($(document).height());
      window.onresize = function(event) {
        $(".full-height").height($(document).height());
      };
    </script>
  </body>
</html>
